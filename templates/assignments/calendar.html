{% extends 'base.html' %}

{% block title %}Schedule - Workers Jobs Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1>Schedule</h1>
        <form method="get" class="d-flex align-items-center gap-2 mt-3">
            <label for="date" class="form-label mb-0"><strong>Date:</strong></label>
            <input type="date" name="date" id="date" class="form-control" style="max-width: 200px;" 
                   value="{{ selected_date|date:'Y-m-d' }}" onchange="this.form.submit()">
            <button type="submit" class="btn btn-primary btn-sm">View</button>
            {% if selected_date != today %}
            <a href="?date={{ today|date:'Y-m-d' }}" class="btn btn-outline-secondary btn-sm">Today</a>
            {% endif %}
        </form>
    </div>
    <div class="col-md-6 text-end">
        <h4 class="text-primary">{{ selected_date|date:"l, F d, Y" }}</h4>
    </div>
</div>

<div class="row">
    <!-- Left Side: Guard Duty Time Slots -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-clock-fill"></i> Guard Duty Schedule</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%;">Time Slot</th>
                                <th style="width: 80%;">Workers ({{ slot.required_workers|default:"1-2" }} needed)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in schedule_data %}
                            <tr>
                                <td class="align-middle text-center">
                                    <strong>{{ slot.time_slot }}</strong>
                                    <br><small class="text-muted">({{ slot.required_workers }})</small>
                                </td>
                                <td class="p-2">
                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                        <!-- Assigned Workers -->
                                        {% for assignment in slot.guard_workers %}
                                            <div class="badge bg-primary d-flex align-items-center gap-1">
                                                {{ assignment.worker.name }}
                                                <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-white" 
                                                            onclick="return confirm('Remove this assignment?')">
                                                        <i class="bi bi-x-circle-fill"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        {% endfor %}
                                        
                                        <!-- Add Worker Button -->
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#addWorkerModal" 
                                                data-task-type="guard_duty" 
                                                data-time-slot="{{ slot.time_slot }}"
                                                data-date="{{ selected_date|date:'Y-m-d' }}">
                                            <i class="bi bi-plus-circle"></i> Add Worker
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Side: Full-Day Tasks -->
    <div class="col-md-4">
        <!-- Kitchen -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-basket2-fill"></i> Kitchen Workers</span>
                <span class="badge bg-light text-dark">{{ kitchen_workers.count }}/2</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for assignment in kitchen_workers %}
                        <div class="badge bg-primary d-flex align-items-center gap-1">
                            {{ assignment.worker.name }}
                            <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-white"
                                        onclick="return confirm('Remove this assignment?')">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addWorkerModal" 
                        data-task-type="kitchen" 
                        data-date="{{ selected_date|date:'Y-m-d' }}">
                    <i class="bi bi-plus-circle"></i> Add Worker
                </button>
            </div>
        </div>

        <!-- Patrol A -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <span><i class="bi bi-shield-fill"></i> Patrol Group A</span>
                <span class="badge bg-dark">{{ patrol_a_workers.count }}/6</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for assignment in patrol_a_workers %}
                        <div class="badge {% if assignment.is_commander %}bg-warning text-dark{% else %}bg-primary{% endif %} d-flex align-items-center gap-1">
                            {% if assignment.is_commander %}★{% endif %} {{ assignment.worker.name }}
                            <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent {% if assignment.is_commander %}text-dark{% else %}text-white{% endif %}"
                                        onclick="return confirm('Remove this assignment?')">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-warning" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addWorkerModal" 
                        data-task-type="patrol_a" 
                        data-date="{{ selected_date|date:'Y-m-d' }}">
                    <i class="bi bi-plus-circle"></i> Add Worker
                </button>
            </div>
        </div>

        <!-- Patrol B -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-shield-fill"></i> Patrol Group B</span>
                <span class="badge bg-light text-dark">{{ patrol_b_workers.count }}/6</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for assignment in patrol_b_workers %}
                        <div class="badge {% if assignment.is_commander %}bg-warning text-dark{% else %}bg-primary{% endif %} d-flex align-items-center gap-1">
                            {% if assignment.is_commander %}★{% endif %} {{ assignment.worker.name }}
                            <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent {% if assignment.is_commander %}text-dark{% else %}text-white{% endif %}"
                                        onclick="return confirm('Remove this assignment?')">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-success" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addWorkerModal" 
                        data-task-type="patrol_b" 
                        data-date="{{ selected_date|date:'Y-m-d' }}">
                    <i class="bi bi-plus-circle"></i> Add Worker
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Worker Modal -->
<div class="modal fade" id="addWorkerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'assignments:assign_worker' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Select Worker</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="date" id="modal-date">
                    <input type="hidden" name="task_type" id="modal-task-type">
                    <input type="hidden" name="time_slot" id="modal-time-slot">
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Select Worker:</strong></label>
                        <select name="worker_id" class="form-select" required>
                            <option value="">-- Choose a worker --</option>
                            {% for worker in all_workers %}
                                <option value="{{ worker.id }}">
                                    {{ worker.name }} ({{ worker.get_title_display }}) - HC: {{ worker.hard_chores_counter }}, OP: {{ worker.outer_partner_counter }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3 form-check" id="commander-checkbox-container" style="display: none;">
                        <input type="checkbox" name="is_commander" class="form-check-input" id="is-commander">
                        <label class="form-check-label" for="is-commander">
                            Assign as Commander (for patrol groups)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Worker</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script>
// Handle modal data transfer
var addWorkerModal = document.getElementById('addWorkerModal');
addWorkerModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var taskType = button.getAttribute('data-task-type');
    var timeSlot = button.getAttribute('data-time-slot');
    var date = button.getAttribute('data-date');
    
    // Set hidden fields
    document.getElementById('modal-task-type').value = taskType;
    document.getElementById('modal-time-slot').value = timeSlot || '';
    document.getElementById('modal-date').value = date;
    
    // Show commander checkbox only for patrol tasks
    var commanderCheckbox = document.getElementById('commander-checkbox-container');
    if (taskType === 'patrol_a' || taskType === 'patrol_b') {
        commanderCheckbox.style.display = 'block';
    } else {
        commanderCheckbox.style.display = 'none';
        document.getElementById('is-commander').checked = false;
    }
});
</script>
{% endblock %}
