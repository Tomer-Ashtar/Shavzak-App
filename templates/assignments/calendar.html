{% extends 'base.html' %}

{% block title %} 砖专转 - 砖抓 拽专{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1> 砖专转</h1>
        <form method="get" class="d-flex align-items-center gap-2 mt-3">
            <label for="date" class="form-label mb-0"><strong>转专:</strong></label>
            <input type="date" name="date" id="date" class="form-control" style="max-width: 200px;" 
                   value="{{ selected_date|date:'Y-m-d' }}" onchange="this.form.submit()">
            <button type="submit" class="btn btn-primary btn-sm">爪</button>
            {% if selected_date != today %}
            <a href="?date={{ today|date:'Y-m-d' }}" class="btn btn-outline-secondary btn-sm"></a>
            {% endif %}
        </form>
    </div>
    <div class="col-md-6 text-start">
        <h4 class="text-primary">{{ selected_date|date:"l, d/m/Y" }}</h4>
    </div>
</div>

<div class="row">
    <!-- Left Side: Guard Duty Time Slots -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-clock-fill"></i>  住专 砖专转</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%;">砖专转</th>
                                <th style="width: 80%;">砖专</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in schedule_data %}
                            <tr {% if slot.time_slot == '01:00-03:00' or slot.time_slot == '03:00-05:00' %}class="table-warning"{% endif %}>
                                <td class="align-middle text-center">
                                    <strong>{{ slot.time_slot }}</strong>
                                    {% if slot.time_slot == '01:00-03:00' or slot.time_slot == '03:00-05:00' %}
                                        <br><small class="badge bg-warning text-dark"> 砖专转  +拽</small>
                                    {% else %}
                                        <br><small class="text-muted">({{ slot.required_workers }})</small>
                                    {% endif %}
                                </td>
                                <td class="p-2">
                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                        <!-- Assigned Workers -->
                                        {% for assignment in slot.guard_workers %}
                                            <div class="badge bg-primary d-flex align-items-center gap-1">
                                                {{ assignment.worker.name }}
                                                <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-white" 
                                                            onclick="return confirm(' 拽 转 砖抓?')">
                                                        <i class="bi bi-x-circle-fill"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        {% endfor %}
                                        
                                        <!-- Add Worker Button -->
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#addWorkerModal" 
                                                data-task-type="guard_duty" 
                                                data-time-slot="{{ slot.time_slot }}"
                                                data-date="{{ selected_date|date:'Y-m-d' }}">
                                            <i class="bi bi-plus-circle"></i> 住祝 砖专
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Side: Full-Day Tasks -->
    <div class="col-md-4">
        <!-- Kitchen -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-basket2-fill"></i> 转专转 </span>
                <span class="badge bg-light text-dark">{{ kitchen_workers.count }}/2</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for assignment in kitchen_workers %}
                        <div class="badge bg-primary d-flex align-items-center gap-1">
                            {{ assignment.worker.name }}
                            <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-white"
                                        onclick="return confirm(' 拽 转 砖抓?')">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addWorkerModal" 
                        data-task-type="kitchen" 
                        data-date="{{ selected_date|date:'Y-m-d' }}">
                    <i class="bi bi-plus-circle"></i> 住祝 注
                </button>
            </div>
        </div>

        <!-- Patrol A -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <span><i class="bi bi-shield-fill"></i>驻专</span>
                <span class="badge bg-dark">{{ patrol_a_workers.count }}/6</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for assignment in patrol_a_workers %}
                        <div class="badge {% if assignment.is_commander %}bg-warning text-dark{% else %}bg-primary{% endif %} d-flex align-items-center gap-1">
                            {% if assignment.is_commander %}{% endif %} {{ assignment.worker.name }}
                            <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent {% if assignment.is_commander %}text-dark{% else %}text-white{% endif %}"
                                        onclick="return confirm(' 拽 转 砖抓?')">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-warning" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addWorkerModal" 
                        data-task-type="patrol_a" 
                        data-date="{{ selected_date|date:'Y-m-d' }}">
                    <i class="bi bi-plus-circle"></i> 住祝 
                </button>
            </div>
        </div>

        <!-- Patrol B -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-shield-fill"></i>专</span>
                <span class="badge bg-light text-dark">{{ patrol_b_workers.count }}/6</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for assignment in patrol_b_workers %}
                        <div class="badge {% if assignment.is_commander %}bg-warning text-dark{% else %}bg-primary{% endif %} d-flex align-items-center gap-1">
                            {% if assignment.is_commander %}{% endif %} {{ assignment.worker.name }}
                            <form method="post" action="{% url 'assignments:remove_assignment' assignment.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent {% if assignment.is_commander %}text-dark{% else %}text-white{% endif %}"
                                        onclick="return confirm(' 拽 转 砖抓?')">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-success" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addWorkerModal" 
                        data-task-type="patrol_b" 
                        data-date="{{ selected_date|date:'Y-m-d' }}">
                    <i class="bi bi-plus-circle"></i> 住祝 
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Worker Modal -->
<div class="modal fade" id="addWorkerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'assignments:assign_worker' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">专 注</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="date" id="modal-date">
                    <input type="hidden" name="task_type" id="modal-task-type">
                    <input type="hidden" name="time_slot" id="modal-time-slot">
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>专 注:</strong></label>
                        <div id="suggested-worker" class="alert alert-success mb-2" style="display: none;">
                            <strong> 爪注 ( 转专):</strong> <span id="suggested-worker-name"></span>
                        </div>
                        <select name="worker_id" class="form-select" id="worker-dropdown" required>
                            <option value="">-- 专 注 --</option>
                            {% for worker in all_workers %}
                                <option value="{{ worker.id }}">
                                    {{ worker.name }} ({{ worker.get_title_display }}) - 拽: {{ worker.hard_chores_counter }}, 砖: {{ worker.outer_partner_counter }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Queue Order Display -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#queue-order">
                            <i class="bi bi-list-ol"></i> 爪 住专 转专
                        </button>
                        <div class="collapse mt-2" id="queue-order">
                            <div class="card card-body">
                                <small id="queue-display" class="text-muted">专 砖  专转 转 转专</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check" id="commander-checkbox-container" style="display: none;">
                        <input type="checkbox" name="is_commander" class="form-check-input" id="is-commander">
                        <label class="form-check-label" for="is-commander">
                            砖抓 驻拽 (拽爪转 住专)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"></button>
                    <button type="submit" class="btn btn-primary">砖抓 注</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script>
// Queue data from backend
var queueSuggestions = {{ queue_suggestions_json|safe }};
var taskQueues = {
    {% for task_type, queue in task_queues.items %}
    '{{ task_type }}': [
        {% for entry in queue %}
        {
            'position': {{ entry.position }},
            'worker_name': '{{ entry.worker.name }}',
            'worker_title': '{{ entry.worker.get_title_display }}',
            'worker_id': {{ entry.worker.id }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// Task type names in Hebrew
var taskTypeNames = {
    'guard_duty': '砖专',
    'kitchen': '',
    'patrol_a': '住专 \'',
    'patrol_b': '住专 \''
};

// Handle modal data transfer
var addWorkerModal = document.getElementById('addWorkerModal');
addWorkerModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var taskType = button.getAttribute('data-task-type');
    var timeSlot = button.getAttribute('data-time-slot');
    var date = button.getAttribute('data-date');
    
    // Set hidden fields
    document.getElementById('modal-task-type').value = taskType;
    document.getElementById('modal-time-slot').value = timeSlot || '';
    document.getElementById('modal-date').value = date;
    
    // Show commander checkbox only for patrol tasks
    var commanderCheckbox = document.getElementById('commander-checkbox-container');
    if (taskType === 'patrol_a' || taskType === 'patrol_b') {
        commanderCheckbox.style.display = 'block';
    } else {
        commanderCheckbox.style.display = 'none';
        document.getElementById('is-commander').checked = false;
    }
    
    // Show suggested worker
    var suggestedDiv = document.getElementById('suggested-worker');
    var suggestedNameSpan = document.getElementById('suggested-worker-name');
    var dropdown = document.getElementById('worker-dropdown');
    
    if (queueSuggestions[taskType]) {
        var suggested = queueSuggestions[taskType];
        suggestedDiv.style.display = 'block';
        suggestedNameSpan.textContent = suggested.name + ' (' + suggested.title + ')';
        
        // Pre-select suggested worker
        dropdown.value = suggested.id;
    } else {
        suggestedDiv.style.display = 'none';
        dropdown.value = '';
    }
    
    // Display queue order
    var queueDisplay = document.getElementById('queue-display');
    if (taskQueues[taskType]) {
        var taskNameHebrew = taskTypeNames[taskType] || taskType;
        var queueHtml = '<strong>住专 转专 注专 ' + taskNameHebrew + ':</strong><ol class="mb-0 mt-2">';
        taskQueues[taskType].forEach(function(entry) {
            queueHtml += '<li>' + entry.worker_name + ' (' + entry.worker_title + ')</li>';
        });
        queueHtml += '</ol>';
        queueDisplay.innerHTML = queueHtml;
    } else {
        queueDisplay.innerHTML = '<em> 转专 </em>';
    }
});
</script>
{% endblock %}
